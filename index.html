<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ardon Light v3.1</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- VARIABLES --- */
        :root {
            --primary: #2563EB; 
            --primary-hover: #1d4ed8;
            --success: #10B981; 
            --danger: #EF4444; 
            --warning: #F59E0B; 
            --dark: #111827; 
            --gray: #6B7280;
            --light: #F3F4F6; 
            --white: #FFFFFF; 
            --border: #E5E7EB;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 12px;
        }

        body {
            font-family: 'Inter', sans-serif; 
            background-color: var(--light); 
            color: var(--dark);
            margin: 0; padding: 0; 
            -webkit-font-smoothing: antialiased;
        }

        /* --- LAYOUT --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* HEADER */
        header {
            background-color: var(--white); padding: 1rem 1.5rem; 
            border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center; 
            position: sticky; top: 0; z-index: 100;
        }
        header h2 { 
            margin: 0; font-size: 1.25rem; color: var(--primary); 
            font-weight: 700; display: flex; align-items: center; gap: 10px; 
        }

        /* --- BUTTONS --- */
        button {
            border: none; border-radius: 8px; padding: 10px 16px; font-size: 0.95rem; font-weight: 500;
            cursor: pointer; transition: all 0.2s; 
        }
        button:active { transform: translateY(1px); }
        button:disabled { opacity: 0.6; cursor: not-allowed; }

        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-hover); }
        
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-warning { background-color: var(--warning); color: white; }
        
        .btn-outline { 
            background-color: white; border: 1px solid var(--border); color: var(--dark); 
            box-shadow: var(--shadow-sm);
        }
        .btn-outline:hover { background-color: #F9FAFB; border-color: #D1D5DB; }

        /* Compact Call Button */
        .btn-call { 
            background-color: #FFF7ED; color: var(--warning); border: 1px solid #FFEDD5;
            padding: 6px 12px; font-size: 0.8rem; border-radius: 6px; font-weight: 600;
        }
        .btn-call:hover { background-color: var(--warning); color: white; border-color: var(--warning); }

        /* --- INPUTS --- */
        input {
            width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px;
            font-size: 1rem; margin-bottom: 1rem; box-sizing: border-box; outline: none;
            transition: border 0.2s;
        }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }

        /* --- VIEWS & SECTIONS --- */
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .active-view { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- LOGIN --- */
        .login-card {
            background: white; padding: 2.5rem; border-radius: var(--radius); 
            box-shadow: var(--shadow-md); max-width: 380px; margin: 4rem auto; text-align: center;
        }

        /* --- PICKER UI --- */
        .status-hero {
            padding: 3rem 1rem; border-radius: var(--radius); color: white; text-align: center;
            margin-bottom: 1.5rem; box-shadow: var(--shadow-md); transition: background 0.3s ease;
        }
        .bg-picking { background: linear-gradient(135deg, #10B981 0%, #059669 100%); }
        .bg-hold { background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%); animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        
        .zone-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 1rem; }
        .zone-btn { 
            background-color: white; border: 1px solid var(--border); color: var(--dark); 
            padding: 1.5rem 0; font-size: 1.25rem; border-radius: 8px; font-weight: 600;
            box-shadow: var(--shadow-sm);
        }
        .zone-btn:active { background-color: #EFF6FF; border-color: var(--primary); color: var(--primary); }

        /* --- MODAL FORM --- */
        .type-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .type-btn { 
            padding: 12px; font-size: 0.85rem; background: #F9FAFB; color: var(--gray); 
            border: 1px solid var(--border); border-radius: 8px;
        }
        .type-btn.selected { 
            border-color: var(--primary); background: #EFF6FF; color: var(--primary); font-weight: 700;
        }

        /* --- DEO DASHBOARD GRID --- */
        .dashboard-grid { 
            display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem; 
        }
        @media (max-width: 900px) { .dashboard-grid { grid-template-columns: 1fr; } }

        .card { 
            background: white; border-radius: var(--radius); 
            box-shadow: var(--shadow-sm); border: 1px solid var(--border); 
            display: flex; flex-direction: column;
        }
        .card-header { 
            padding: 1rem 1.25rem; border-bottom: 1px solid var(--border); 
            font-weight: 600; display: flex; justify-content: space-between; align-items: center; 
            background-color: #ffffff; border-radius: var(--radius) var(--radius) 0 0;
        }
        .card-body { padding: 0; max-height: 400px; overflow-y: auto; flex-grow: 1; }
        
        .empty-state { padding: 2.5rem; text-align: center; color: #9CA3AF; font-size: 0.9rem; font-style: italic; }

        /* --- TICKET ITEMS --- */
        .ticket-item { 
            padding: 1rem 1.25rem; border-bottom: 1px solid var(--border); 
            display: flex; justify-content: space-between; align-items: center; 
            transition: background 0.1s;
        }
        .ticket-item:hover { background-color: #FEF2F2; }
        .ticket-details h4 { margin: 0; font-size: 1rem; color: var(--dark); display: flex; align-items: center; gap: 8px;}
        
        .badge { 
            padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; 
            font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .badge-red { background: #FEE2E2; color: #991B1B; border: 1px solid #FECACA; }
        .badge-zone { background: #E0E7FF; color: #3730A3; border: 1px solid #C7D2FE; }

        .ticket-meta { margin-top: 6px; font-size: 0.85rem; color: var(--gray); display: flex; gap: 12px; align-items: center; }
        .meta-item { display: flex; align-items: center; gap: 4px; }

        /* --- PICKER LIST --- */
        .picker-item { 
            padding: 0.75rem 1.25rem; border-bottom: 1px solid var(--border); 
            display: flex; justify-content: space-between; align-items: center; 
        }
        .picker-info { display: flex; align-items: center; gap: 12px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .dot-green { background-color: var(--success); box-shadow: 0 0 0 3px #D1FAE5; }
        .dot-red { background-color: var(--danger); box-shadow: 0 0 0 3px #FEE2E2; }
        
        .picker-name { font-weight: 600; font-size: 0.9rem; color: var(--dark); }
        .picker-status { font-size: 0.75rem; color: var(--gray); margin-top: 2px;}

        /* --- HISTORY TABLE --- */
        .history-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .history-table th { 
            background-color: #F9FAFB; padding: 12px 16px; text-align: left; 
            color: var(--gray); font-weight: 600; border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }
        .history-table td { padding: 12px 16px; border-bottom: 1px solid var(--border); color: var(--dark); vertical-align: middle; }
        .history-table tr:last-child td { border-bottom: none; }
        
        .cat-tag { 
            display: inline-block; padding: 2px 8px; border-radius: 12px; 
            font-size: 0.75rem; font-weight: 600; background: #F3F4F6; color: var(--dark);
        }

        /* --- OVERLAYS --- */
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal { background: white; padding: 1.5rem; border-radius: var(--radius); width: 90%; max-width: 420px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        
        #callout-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--danger); z-index: 3000; color: white; flex-direction: column; justify-content: center; align-items: center; text-align: center; animation: flash 1s infinite; }
        @keyframes flash { 0%, 100% { background-color: var(--danger); } 50% { background-color: #B91C1C; } }

        #toast { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); background-color: #1F2937; color: white; padding: 10px 20px; border-radius: 50px; z-index: 9999; transition: top 0.4s; font-size: 0.9rem; font-weight: 500; display: flex; align-items: center; gap: 8px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        #toast.show { top: 20px; }
        
        /* Utils */
        .count-badge { background: var(--danger); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; margin-left: 8px; }
        .count-badge.green { background: var(--success); }
    </style>
</head>
<body>

    <div id="toast"><span>üîî</span> <span id="toast-msg">Message</span></div>
    <audio id="alert-sound" preload="auto" src="data:audio/mp3;base64,//NExAAAAaniaAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//NExAAAAaniaAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//NExAAAAaniaAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//NExAAAAaniaAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//NExAAAAaniaAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//NExAAAAaniaAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//NExAAAAaniaAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//NExAAAAaniaAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq" type="audio/mpeg"></audio>

    <div id="callout-overlay">
        <div style="font-size: 4rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
        <h1 style="font-size: 2.5rem; margin: 0; line-height: 1.1;">REPORT TO<br>DESK</h1>
        <button onclick="acknowledgeCallout()" style="margin-top: 2rem; background: white; color: var(--danger); padding: 1rem 3rem; font-size: 1.1rem; border-radius: 50px; font-weight: 700;">I AM COMING</button>
    </div>

    <div id="picker-input-modal" class="overlay">
        <div class="modal">
            <h3 style="margin-top:0; font-size: 1.2rem;">Raise Issue</h3>
            <div style="background:#EFF6FF; padding:10px; border-radius:8px; margin-bottom:15px; color:var(--primary); font-weight:600; font-size:0.9rem;">
                üìç Zone: <span id="modal-zone-display">--</span>
            </div>

            <div style="margin-bottom: 15px; text-align: left;">
                <label style="display:block; font-size:0.85rem; font-weight:600; color:var(--gray); margin-bottom:6px;">Select Issue Category</label>
                <div class="type-grid">
                    <button class="type-btn" onclick="selectPickerType(this, 'WID Issue')">WID</button>
                    <button class="type-btn" onclick="selectPickerType(this, 'Printer Issue')">Printer</button>
                    <button class="type-btn" onclick="selectPickerType(this, 'Tech Issue')">Tech</button>
                </div>
            </div>

            <div style="margin-bottom: 20px; text-align: left;">
                <label style="display:block; font-size:0.85rem; font-weight:600; color:var(--gray); margin-bottom:6px;">Picklist ID</label>
                <input type="text" id="input-picklist-id" placeholder="Scan or Type PL...">
            </div>

            <div style="display:flex; gap:10px;">
                <button class="btn-outline" style="flex:1;" onclick="closePickerModal()">Cancel</button>
                <button class="btn-primary" style="flex:1;" onclick="submitTicketFinal()">Notify DEO</button>
            </div>
        </div>
    </div>

    <div id="resolve-modal" class="overlay">
        <div class="modal">
            <h3 style="margin-top:0;">Final Resolution</h3>
            <p style="color: var(--gray); font-size:0.9rem; margin-bottom: 15px;">Select the final category to close this ticket.</p>
            
            <div style="text-align:left; background:#F9FAFB; padding:12px; border-radius:8px; margin-bottom:15px; font-size:0.85rem; border:1px solid var(--border);">
                <div style="margin-bottom:4px;"><b>Picklist:</b> <span id="res-pl-id">--</span></div>
                <div><b>Reported as:</b> <span id="res-reported" style="color:var(--danger)">--</span></div>
            </div>
            
            <div class="type-grid" style="grid-template-columns: 1fr 1fr;">
                <button class="type-btn" onclick="confirmDeoResolve('WID Issue')">WID Issue</button>
                <button class="type-btn" onclick="confirmDeoResolve('IBL Issue')">IBL Issue</button>
                <button class="type-btn" onclick="confirmDeoResolve('PNF Issue')">PNF Issue</button>
                <button class="type-btn" onclick="confirmDeoResolve('Packing Cancel')">Packing Cancel</button>
                <button class="type-btn" onclick="confirmDeoResolve('Tech Issue')">Tech Issue</button>
                <button class="type-btn" onclick="confirmDeoResolve('Specification')">Specification</button>
            </div>
            <button class="btn-outline" style="margin-top: 15px; width: 100%;" onclick="closeResolveModal()">Cancel</button>
        </div>
    </div>

    <header>
        <div style="display:flex; align-items:center; gap:8px;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="color:var(--primary);"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path></svg>
            <h2>Ardon Light v3.1</h2>
        </div>
        <div style="display:flex; align-items:center; gap:10px;">
            <div id="user-badge" style="display:none; font-weight:600; font-size: 0.85rem; background: var(--light); padding: 6px 12px; border-radius: 20px;"></div>
            <button id="logout-btn" class="btn-outline" onclick="handleLogout()" style="display:none; padding: 6px 12px; font-size:0.8rem;">Logout</button>
        </div>
    </header>

    <div class="container">

        <div id="view-login" class="view-section active-view">
            <div class="login-card">
                <h2 style="margin-bottom: 1.5rem; font-size: 1.5rem;">Welcome</h2>
                <div style="text-align: left; margin-bottom: 5px; font-size: 0.85rem; font-weight: 600; color: var(--gray);">Casper ID / Employee ID</div>
                <input type="text" id="input-casper-id" placeholder="e.g. 1024 or DEO">
                <button id="btn-login" class="btn-primary" onclick="handleLogin()" disabled>Connecting...</button>
                <p id="loading-msg" style="margin-top: 1rem; color: var(--gray); font-size: 0.8rem;">Securely connecting to database...</p>
            </div>
        </div>

        <div id="view-picker" class="view-section">
            <div id="picker-status-card" class="status-hero bg-picking">
                <div style="font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.9; margin-bottom: 5px;">Current Status</div>
                <h1 id="status-text" style="font-size: 2.5rem;">PICKING</h1>
                <p id="display-zone-info" style="display:none; margin-top:5px; font-size: 1.1rem;">Help coming to <span id="display-zone" style="font-weight:700;">--</span></p>
            </div>

            <div id="picker-controls">
                <button class="btn-danger" style="height: 100px; width: 100%; font-size: 1.25rem; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px;" onclick="toggleZoneSelector()">
                    <span style="font-size: 1.5rem;">‚úã</span>
                    <span>RAISE ISSUE</span>
                </button>
            </div>

            <div id="picker-waiting" style="display:none;">
                <div style="background: white; padding: 1.5rem; border-radius: var(--radius); border: 1px solid var(--border); text-align: left; margin-bottom: 1rem;">
                    <h3 style="margin: 0 0 10px 0; color: var(--dark);">Details Sent</h3>
                    <div style="display:grid; grid-template-columns: auto 1fr; gap: 8px 15px; font-size: 0.95rem;">
                        <span style="color:var(--gray);">Reported:</span>
                        <span id="wait-type" style="font-weight:600;">--</span>
                        <span style="color:var(--gray);">Picklist:</span>
                        <span id="wait-pl" style="font-weight:600; font-family:monospace;">--</span>
                    </div>
                    <p style="color: var(--gray); font-size: 0.85rem; margin-top:15px; font-style: italic;">Stay at your location. DEO is en route.</p>
                </div>
                <button class="btn-warning" onclick="cancelActiveTicket()">CANCEL / FALSE ALARM</button>
            </div>

            <div id="zone-selector" style="display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 1rem;">
                    <h3 style="margin:0; font-size: 1.1rem;">Select Location</h3>
                    <button class="btn-outline" style="padding: 6px 12px; font-size:0.8rem;" onclick="cancelZoneSelection()">Cancel</button>
                </div>
                <div class="zone-grid" id="zone-buttons"></div>
            </div>
        </div>

        <div id="view-deo" class="view-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 1.5rem;">
                <h2 style="margin:0;">Dashboard</h2>
                <button onclick="testNotification()" class="btn-outline" style="padding: 8px 12px; font-size: 0.85rem;">üîä Test Alert</button>
            </div>

            <div class="dashboard-grid">
                <div class="card">
                    <div class="card-header">
                        <div style="display:flex; align-items:center;">
                            <span style="display:inline-block; width:8px; height:8px; background:var(--danger); border-radius:50%; margin-right:8px;"></span>
                            Active Issues
                            <span id="issue-count" class="count-badge">0</span>
                        </div>
                    </div>
                    <div class="card-body" id="ticket-list">
                        <div class="empty-state">No active issues.</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div style="display:flex; align-items:center;">
                            <span style="display:inline-block; width:8px; height:8px; background:var(--success); border-radius:50%; margin-right:8px;"></span>
                            Active Pickers
                            <span id="picker-count" class="count-badge green">0</span>
                        </div>
                    </div>
                    <div class="card-body" id="active-pickers-list">
                        <div class="empty-state">No pickers online.</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span style="display:flex; align-items:center; gap:8px;">üìÑ Logs (Final Bucketing)</span>
                    <button onclick="downloadCSV()" class="btn-outline" style="padding: 6px 10px; font-size: 0.8rem;">‚¨á CSV</button>
                </div>
                <div class="card-body">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>ID</th>
                                <th>Zone</th>
                                <th>Final Category</th>
                                <th>Picklist</th>
                                <th style="text-align:right;">Time Lost</th>
                            </tr>
                        </thead>
                        <tbody id="history-list"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, push, onValue, remove, set, onChildAdded, get, update, onDisconnect } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // --- REPLACE WITH YOUR FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBIg1Qdo-GPYFV6ML2JNOLSyx-Jrllmx5s",
            authDomain: "ardon-4b555.firebaseapp.com",
            projectId: "ardon-4b555",
            storageBucket: "ardon-4b555.firebasestorage.app",
            messagingSenderId: "881199734184",
            appId: "1:881199734184:web:1531178087c7174b3b519d",
            measurementId: "G-6S353PQEKG"
        };

        const PICKER_LIST_URL = "https://raw.githubusercontent.com/Pranav-In11/ArdonLight/main/pickers.json"; 

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let authorizedPickers = [];
        let currentUser = "";
        let currentTicketId = null;
        let isDeoMode = false;
        let initialLoadComplete = false; 
        let allHistoryData = [];
        let alertInterval = null;

        // Temporary Data
        let tempZone = "";
        let tempPickerHint = "";
        let pendingResolveTicket = null;

        // --- INIT ---
        (async function initSystem() {
            try {
                const response = await fetch(PICKER_LIST_URL);
                if (response.ok) authorizedPickers = await response.json();
            } catch (error) { console.error("List fetch error", error); }
            
            const savedUser = localStorage.getItem('ardon_user');
            if (savedUser) {
                currentUser = savedUser;
                if (currentUser === 'DEO' || currentUser === 'ADMIN') enterDeoMode();
                else enterPickerMode();
            } else {
                document.getElementById('btn-login').disabled = false;
                document.getElementById('btn-login').innerText = "Start Shift";
                document.getElementById('loading-msg').style.display = 'none';
            }
        })();

        // --- LOGIN/LOGOUT ---
        window.handleLogin = function() {
            const inputId = document.getElementById('input-casper-id').value.toUpperCase().trim();
            if(!inputId) return showToast("Please enter ID");
            unlockAudio();

            if (inputId === 'DEO' || inputId === 'ADMIN') {
                currentUser = inputId;
                localStorage.setItem('ardon_user', currentUser);
                if ("Notification" in window) Notification.requestPermission();
                enterDeoMode();
                return;
            }

            let isValidUser = true; 
            if(authorizedPickers.length > 0) isValidUser = authorizedPickers.some(id => String(id).toUpperCase() === inputId);

            if (isValidUser) {
                currentUser = inputId;
                localStorage.setItem('ardon_user', currentUser);
                enterPickerMode();
            } else {
                showToast("Access Denied.");
            }
        }

        window.handleLogout = function() {
            if (!isDeoMode && currentUser) remove(ref(db, 'active_pickers/' + currentUser));
            localStorage.removeItem('ardon_user');
            location.reload();
        }

        function enterDeoMode() {
            document.getElementById('view-login').classList.remove('active-view');
            document.getElementById('view-deo').classList.add('active-view');
            document.getElementById('user-badge').style.display = "block";
            document.getElementById('user-badge').innerText = "Manager Mode";
            document.getElementById('logout-btn').style.display = "block";
            isDeoMode = true;
            initManagerListener();
            initHistoryListener(); 
            initActivePickersListener();
        }

        function enterPickerMode() {
            document.getElementById('view-login').classList.remove('active-view');
            document.getElementById('view-picker').classList.add('active-view');
            document.getElementById('user-badge').style.display = "block";
            document.getElementById('user-badge').innerText = `Picker: ${currentUser}`;
            document.getElementById('logout-btn').style.display = "block";
            isDeoMode = false;
            generateZones();
            initPickerListener(); 
            
            const myPresenceRef = ref(db, 'active_pickers/' + currentUser);
            set(myPresenceRef, { status: 'PICKING', last_seen: Date.now(), call_out: false });
            onDisconnect(myPresenceRef).remove();

            onValue(myPresenceRef, (snapshot) => {
                const data = snapshot.val();
                if(data && data.call_out === true) startCalloutAlert();
                else stopCalloutAlert();
            });
        }

        // --- PICKER WORKFLOW ---
        window.toggleZoneSelector = () => {
            document.getElementById('picker-controls').style.display = 'none';
            document.getElementById('zone-selector').style.display = 'block';
        }
        window.cancelZoneSelection = () => {
            document.getElementById('picker-controls').style.display = 'block';
            document.getElementById('zone-selector').style.display = 'none';
        }

        window.openDetailForm = function(zone) {
            tempZone = zone;
            tempPickerHint = "";
            document.getElementById('input-picklist-id').value = "";
            document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById('modal-zone-display').innerText = zone;
            document.getElementById('picker-input-modal').style.display = 'flex';
        }

        window.selectPickerType = function(btn, type) {
            tempPickerHint = type;
            document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
        }
        window.closePickerModal = () => document.getElementById('picker-input-modal').style.display = 'none';

        window.submitTicketFinal = function() {
            const picklistId = document.getElementById('input-picklist-id').value.trim().toUpperCase();
            
            if(!tempPickerHint) return showToast("Select Cause");
            if(!picklistId) return showToast("Enter Picklist ID");

            const newTicketRef = push(ref(db, 'tickets')); 
            set(newTicketRef, {
                casper_id: currentUser,
                zone: tempZone,
                picker_hint_type: tempPickerHint,
                picklist_id: picklistId,
                timestamp: Date.now()
            }).then(() => {
                currentTicketId = newTicketRef.key;
                setPickerState('HOLD', tempZone, tempPickerHint, picklistId);
                update(ref(db, 'active_pickers/' + currentUser), { status: 'ISSUE (' + tempZone + ')' });
                closePickerModal();
            });
        }

        function setPickerState(state, zone, type, pl) {
            const hero = document.getElementById('picker-status-card');
            
            if (state === 'HOLD') {
                hero.className = 'status-hero bg-hold';
                document.getElementById('status-text').innerText = 'STOPPED';
                document.getElementById('display-zone').innerText = zone;
                document.getElementById('display-zone-info').style.display = 'block';
                document.getElementById('wait-type').innerText = type || "--";
                document.getElementById('wait-pl').innerText = pl || "--";
                document.getElementById('zone-selector').style.display = 'none';
                document.getElementById('picker-waiting').style.display = 'block';
            } else {
                hero.className = 'status-hero bg-picking';
                document.getElementById('status-text').innerText = 'PICKING';
                document.getElementById('display-zone-info').style.display = 'none';
                document.getElementById('picker-controls').style.display = 'block';
                document.getElementById('picker-waiting').style.display = 'none';
                document.getElementById('zone-selector').style.display = 'none';
                currentTicketId = null;
            }
        }

        // --- DEO VIEW ---
        function initManagerListener() {
            const listContainer = document.getElementById('ticket-list');
            const countBadge = document.getElementById('issue-count');

            onValue(ref(db, 'tickets'), (snapshot) => {
                const data = snapshot.val();
                listContainer.innerHTML = "";
                let count = 0;

                if (!data) {
                    listContainer.innerHTML = '<div class="empty-state">No active issues.</div>';
                } else {
                    Object.keys(data).forEach(key => {
                        count++;
                        const ticket = data[key];
                        const timeAgo = Math.floor((Date.now() - ticket.timestamp) / 60000); 
                        
                        const ticketDataStr = encodeURIComponent(JSON.stringify({...ticket, key: key}));

                        const html = `
                        <div class="ticket-item">
                            <div class="ticket-details">
                                <h4><span class="badge badge-zone">${ticket.zone}</span> &nbsp;${ticket.casper_id}</h4>
                                <div class="ticket-meta">
                                    <div class="meta-item"><span class="badge badge-red">!</span> ${ticket.picker_hint_type}</div>
                                    <div class="meta-item">üìÑ ${ticket.picklist_id}</div>
                                    <div class="meta-item">‚è± ${timeAgo}m</div>
                                </div>
                            </div>
                            <button class="btn-primary" style="padding: 6px 14px;" onclick="promptDeoResolve('${ticketDataStr}')">Resolve</button>
                        </div>`;
                        listContainer.innerHTML += html;
                    });
                }
                countBadge.innerText = count;
                initialLoadComplete = true;
            });

            onChildAdded(ref(db, 'tickets'), (snapshot) => {
                if (initialLoadComplete) triggerAlert(snapshot.val().zone);
            });
        }

        // DEO ACTIONS
        window.promptDeoResolve = function(ticketDataStr) {
            const ticket = JSON.parse(decodeURIComponent(ticketDataStr));
            pendingResolveTicket = ticket; 
            document.getElementById('res-pl-id').innerText = ticket.picklist_id;
            document.getElementById('res-reported').innerText = ticket.picker_hint_type;
            document.getElementById('resolve-modal').style.display = 'flex';
        }

        window.confirmDeoResolve = function(finalCategory) {
            if(pendingResolveTicket) {
                archiveAndResolve(pendingResolveTicket, finalCategory);
                closeResolveModal();
            }
        }

        window.closeResolveModal = () => {
            document.getElementById('resolve-modal').style.display = 'none';
            pendingResolveTicket = null;
        }

        // --- SHARED ACTIONS ---
        function generateZones() {
            const container = document.getElementById('zone-buttons');
            const aisles = ['A', 'B', 'C', 'D', 'E', 'F'];
            let html = '';
            aisles.forEach(aisle => {
                for(let i=1; i<=3; i++) { 
                    html += `<button class="zone-btn" onclick="openDetailForm('${aisle+i}')">${aisle+i}</button>`;
                }
            });
            container.innerHTML = html;
        }

        window.cancelActiveTicket = function() {
            if(currentTicketId) {
                const ticketRef = ref(db, 'tickets/' + currentTicketId);
                get(ticketRef).then((snapshot) => {
                    if (snapshot.exists()) {
                        const t = snapshot.val();
                        archiveAndResolve({...t, key: currentTicketId}, 'False Alarm');
                    }
                });
            }
        }

        function archiveAndResolve(ticket, finalOutcome) {
            const duration = Date.now() - ticket.timestamp;
            // Prevent undefined string in database
            const safeCategory = finalOutcome || "Resolved";

            push(ref(db, 'history'), {
                casper_id: ticket.casper_id,
                zone: ticket.zone,
                picklist_id: ticket.picklist_id,
                picker_hint: ticket.picker_hint_type, 
                final_category: safeCategory,
                start_time: ticket.timestamp,
                end_time: Date.now(),
                duration_ms: duration
            });
            
            remove(ref(db, 'tickets/' + ticket.key));
            if(ticket.casper_id) update(ref(db, 'active_pickers/' + ticket.casper_id), { status: 'PICKING' });
        }

        // --- HISTORY TABLE ---
        function initHistoryListener() {
            const historyTable = document.getElementById('history-list');
            onValue(ref(db, 'history'), (snapshot) => {
                const data = snapshot.val();
                historyTable.innerHTML = "";
                if(data) {
                    allHistoryData = Object.values(data).sort((a,b) => b.end_time - a.end_time);
                    allHistoryData.slice(0, 20).forEach(entry => {
                        const sec = Math.round(entry.duration_ms / 1000);
                        const time = new Date(entry.start_time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                        
                        // Handle potential undefined values
                        const category = entry.final_category || "Resolved";
                        const picklist = entry.picklist_id || "-";

                        historyTable.innerHTML += `<tr>
                            <td>${time}</td>
                            <td style="font-weight:600;">${entry.casper_id}</td>
                            <td><span class="badge badge-zone">${entry.zone}</span></td>
                            <td><span class="cat-tag">${category}</span></td>
                            <td style="font-family:monospace;">${picklist}</td>
                            <td style="text-align:right; font-weight:700;">${sec}s</td>
                        </tr>`;
                    });
                }
            });
        }

        window.downloadCSV = function() {
            if(!allHistoryData.length) return showToast("No data to export");
            let csv = "data:text/csv;charset=utf-8,Date,Time,Picker ID,Zone,Reported Hint,Picklist ID,Final Category,Duration (Seconds)\n";
            allHistoryData.forEach(row => {
                const d = new Date(row.start_time);
                csv += `${d.toLocaleDateString()},${d.toLocaleTimeString()},${row.casper_id},${row.zone},"${row.picker_hint}","${row.picklist_id}","${row.final_category}",${Math.round(row.duration_ms/1000)}\n`;
            });
            const link = document.createElement("a");
            link.href = encodeURI(csv);
            link.download = `ardon_report_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        // --- ALERTS ---
        function initActivePickersListener() {
            const listContainer = document.getElementById('active-pickers-list');
            const countBadge = document.getElementById('picker-count');
            onValue(ref(db, 'active_pickers'), (snapshot) => {
                const data = snapshot.val();
                listContainer.innerHTML = "";
                let count = 0;
                if (!data) {
                    listContainer.innerHTML = '<div class="empty-state">No pickers online.</div>';
                } else {
                    Object.keys(data).forEach(pickerId => {
                        count++;
                        const picker = data[pickerId];
                        const isIssue = picker.status.includes('ISSUE');
                        const dotClass = isIssue ? 'dot-red' : 'dot-green';
                        listContainer.innerHTML += `
                        <div class="picker-item">
                            <div class="picker-info">
                                <div class="status-dot ${dotClass}"></div>
                                <div><div class="picker-name">${pickerId}</div><div class="picker-status">${picker.status}</div></div>
                            </div>
                            <button class="btn-call" onclick="callOutPicker('${pickerId}')">üì¢ CALL</button>
                        </div>`;
                    });
                }
                countBadge.innerText = count;
            });
        }

        function initPickerListener() {
            onValue(ref(db, 'tickets'), (snapshot) => {
                const data = snapshot.val();
                let exists = false;
                if (data) {
                    Object.keys(data).forEach(key => {
                        if (key === currentTicketId) exists = true;
                    });
                }
                if (currentTicketId && !exists) setPickerState('PICKING'); // Resolved
            });
        }

        window.callOutPicker = (id) => {
            if(confirm(`Alert ${id}?`)) {
                update(ref(db, 'active_pickers/' + id), { call_out: true });
                showToast(`Alert sent to ${id}`);
            }
        };
        window.acknowledgeCallout = () => {
            stopCalloutAlert();
            update(ref(db, 'active_pickers/' + currentUser), { call_out: false });
        };
        function startCalloutAlert() {
            const overlay = document.getElementById('callout-overlay');
            if(overlay.style.display === 'flex') return;
            overlay.style.display = 'flex';
            alertInterval = setInterval(() => {
                 if ('speechSynthesis' in window) {
                    window.speechSynthesis.speak(new SpeechSynthesisUtterance("Report to desk immediately"));
                }
                if (navigator.vibrate) navigator.vibrate([500, 200, 500]);
            }, 3000);
        }
        function stopCalloutAlert() {
            document.getElementById('callout-overlay').style.display = 'none';
            if(alertInterval) clearInterval(alertInterval);
            if('speechSynthesis' in window) window.speechSynthesis.cancel();
        }
        function triggerAlert(zone) {
            const msg = `Issue in Zone ${zone}`;
            showToast(msg);
             if ('speechSynthesis' in window) window.speechSynthesis.speak(new SpeechSynthesisUtterance(msg));
            if ("Notification" in window && Notification.permission === "granted") new Notification("Ardon Light", { body: msg, requireInteraction: true });
        }
        function unlockAudio() {
            const audio = document.getElementById('alert-sound');
            audio.play().catch(e=>{});
        }
        window.testNotification = () => triggerAlert("TEST");
        window.showToast = (msg) => {
             const t = document.getElementById("toast");
             document.getElementById("toast-msg").innerText = msg;
             t.classList.add("show");
             setTimeout(()=>t.classList.remove("show"), 3000);
        }
    </script>
</body>
</html>
